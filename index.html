<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="IT or life article">
<meta name="keywords" content="IT Java programer">
<meta property="og:type" content="website">
<meta property="og:title" content="马丁每天都很忙">
<meta property="og:url" content="https:&#x2F;&#x2F;martin6699s.github.io&#x2F;index.html">
<meta property="og:site_name" content="马丁每天都很忙">
<meta property="og:description" content="IT or life article">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://martin6699s.github.io/"/>





  <title>马丁每天都很忙</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">马丁每天都很忙</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">努力奔跑~~~</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://martin6699s.github.io/2019/10/24/Java-OutputStream/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="martin6699s(JinSheng Lin)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="马丁每天都很忙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/24/Java-OutputStream/" itemprop="url">Java-OutputStream</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-24T16:17:25+08:00">
                2019-10-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/asset/images/post-2.jpg" alt=""></p>
<h2 id="JAVA-OutputStream-FileOutputStream-OutputStreamWriter-BufferWriter-FileWriter总结"><a href="#JAVA-OutputStream-FileOutputStream-OutputStreamWriter-BufferWriter-FileWriter总结" class="headerlink" title="JAVA-  OutputStream\FileOutputStream\OutputStreamWriter\BufferWriter\FileWriter总结"></a>JAVA-  OutputStream\FileOutputStream\OutputStreamWriter\BufferWriter\FileWriter总结</h2><p>介绍：</p>
<ol>
<li><p>OutputStream: </p>
<p>OutputStream是字节输出流的所有类的超类，是个抽象类。输出流接收到字节流并将其发送到某个底层接收器。输出流各式各样，有文件输出流(FileOutputStream)，GZIP输出流(GZIPOutputStream)，对象输出流(ObjectOutputStream)。 </p>
</li>
<li><p>FileOutputStream: </p>
<p>FIleOutputStream是用于将数据写入到输出流File或者文件描述符，文件是否打开或被创建取决于底层操作系统。有些操作系统只允许一次只能打开一个文件来写入文件字节流FileOutputStream。在这种情况下，如果文件已被打开或不存在且无法创建文件(权限原因)，则此类的构造方法将报错FileNotFoundException异常。<strong>FileOutputStream用于如图像数据的原始字节流写入</strong>，<code>对于写入字符流，请考虑使用FileWriter</code>。</p>
</li>
<li><p>OutputStreamWriter:</p>
<p>说OutputStreamWriter之前，先说下OutputStreamWriter的超类Writer，Writer抽象类目的是为了能写入字符流，提供抽象方法write给子类自行实现，并<strong>继承了flushable接口(实现了flushable接口类在使用flush()方法时，会将缓存输出流写入到底层设备上，如File输出流写入到文件中，网络套接字输出流经TCP/IP发送到底层设备 再传输到指定地址)</strong>。封装了操作OutputStream输出的一系列动作和优化。</p>
<p>而OutputStreamWriter是封装了OutputStream子类的Writer类，是把字符流（也就是字符数组或字符串）转换为字节流写入到底层设备。可以指定字符集，或使用系统默认字符集。每次调用write()方法都会在给定字符上调用编码转换器（也就是把字符转换为指定字符集的编码）,并把生成的字节在写入底层输出流之前写入到缓存区中积累<strong>（缓冲区大小默认8192字节）</strong>。【注意： 传递给write()方法的字符不会缓冲，转换的字节会被缓冲 】</p>
<blockquote>
<p>为了最大的效率，请考虑在BufferedWriter中包装一个OutputStreamWriter，以避免频繁的转换器调用。 例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Writer out</span><br><span class="line"> = new BufferedWriter(new OutputStreamWriter(System.out)); </span><br></pre></td></tr></table></figure>
</blockquote>
<p>这种多次调用转换器的情况 就个人理解，发生在多次调用write方法才会发生。</p>
</li>
</ol>
<ol start="4">
<li>FileWriter</li>
</ol>
<p>FileWriter为写入文件提供便利，是OutputStreamWriter的子类，FileWriter类构造器中使用FileOutputStream传递给父类OutputStreamWriter操作。可以理解为FileOutputStream文件输出流和OutputStreamWriter的组合。<strong>缺点是使用系统字符集，不能自己指定字符集。</strong></p>
<ol start="5">
<li>BufferedWriter:</li>
</ol>
<p>顾名思义 带缓冲区的Writer类，写文本到指定的字符输出流，缓存字符，以便有效地写入字符、数组、字符串。除非需要及时输出，否则建议使用BufferedWriter包装OutputStreamWriter或者FileWriter等类写入字符，<strong>BufferedWriter提供的缓冲区默认8192字符（也可以自己指定）， 可以减少多次为输出流分配内存</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FileOutputStream outputStream=<span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">OutputStreamWriter writer=<span class="keyword">new</span> OutputStreamWriter(outputStream,<span class="string">"GBK"</span>);</span><br><span class="line">BufferedWriter bufferedWriter=<span class="keyword">new</span> BufferedWriter(writer);</span><br></pre></td></tr></table></figure>

<p> BufferedWriter封装的是writer，也就是当buffer满了让别的writer去处理输出，而OutputStreamWriter封装的事数据流(OutputStream)，它是让数据流去处理输出 </p>
<p><strong>要理清OutputStream和OutputStreamWriter的关系，OutputStream可以理解为一种资源，例如水，而OutputStreamWriter可以理解为一直操作工具，例如水龙头。水龙头控制着水的流出。而BufferedWriter可以理解为有储水箱的水龙头。</strong></p>
<p><strong>stream和writer的不同，一个是二进制数据，一个是字符数据</strong> </p>
<p><strong>上述OutputStreamWriter和BufferWriter说的缓冲是指程序本身的缓冲，不是操作系统层面的缓冲（或者TCP发送缓冲区），调用flush方法是时将程序缓冲区数据写入到操作系统缓冲上。</strong></p>
<p><a href="https://blog.csdn.net/zhangcarcard/article/details/51210811" target="_blank" rel="noopener">深入解析Java中Flushable接口的flush方法</a></p>
<p> <a href="https://blog.csdn.net/HD243608836/article/details/87882100" target="_blank" rel="noopener">FileOutputStream,OutputStreamWriter, BufferedWriter为什么连用？</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://martin6699s.github.io/2019/10/24/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="martin6699s(JinSheng Lin)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="马丁每天都很忙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/24/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-24T15:22:38+08:00">
                2019-10-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://martin6699s.github.io/2019/10/24/Java-Instrumentation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="martin6699s(JinSheng Lin)">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="马丁每天都很忙">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/24/Java-Instrumentation/" itemprop="url">Java-Instrumentation</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-24T14:16:47+08:00">
                2019-10-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/asset/images/post-1.jpg" alt=""></p>
<p>instrumentation是JAVA SE 5 引进来的新特性，它可以构建一个独立于应用程序的代理程序，用于监控和协助运行在JVM上的程序，甚至能够替换和修改某些类的定义（这类功能被叫做打桩或插桩，另外如ASM、javasisst也是打桩、插桩），实现JVM级别的AOP，不过只能在程序启动之前javaagent指定代理程序。到JAVA SE 6，对instrument功能进行了增强，还可以支持程序启动后的 instrument、本地代码（native code）instrument，以及动态改变 classpath 等等，具体能做的如：内存dump，线程dump，类信息统计（比如加载的类及大小以及实际个数），非侵入式运行时AOP（btrace及阿里出品的jvm-sandbox就是使用了instrument），动态设置vm flag(但没有几个可以用的，因为有些flag都是在jvm启动过程中使用，是一次性的)，打印vm flag，获取系统属性等。</p>
<h2 id="Instrumentation-的基本功能和用法"><a href="#Instrumentation-的基本功能和用法" class="headerlink" title="Instrumentation 的基本功能和用法"></a>Instrumentation 的基本功能和用法</h2><p><code>java.lang.instrument</code>包的具体实现，依赖于JVMTI。JVMTI（Java Virtual Machine Tool Interface）是一套由Java虚拟机提供的，为JVM相关的工具提供的本地编程接口集合。JVMTI能做什么呢？它支持第三方工具程序以代理的方式连接和访问JVM（实际上就是进程间socket通信），并利用JVMTI提供的丰富的编码接口，完成很多跟JVM相关的功能。</p>
<p>Instrumentation有两种方式：</p>
<ol>
<li>premain方式，在程序启动之前通过<code>-javaagent</code>指定代理程序; （Java se 5）</li>
<li>agentmain方式，在程序启动之后指定代理程序;（Java se 6）</li>
</ol>
<h3 id="premain方式"><a href="#premain方式" class="headerlink" title="premain方式"></a>premain方式</h3><h4 id="（1）说明"><a href="#（1）说明" class="headerlink" title="（1）说明"></a>（1）说明</h4><p>在Java SE 5当中，开发者可以让Instrumentation代理在main函数运行前执行。这种方式可以能够替换和修改某些类的定义，增加方法、删除方法，修改方法等。实现具体步骤如下：</p>
<ol>
<li><p>代理程序编写premain函数</p>
<p>   在代理程序中编写一个Java类，包含以下两个方法之一：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">（1） public static void premain(String agentArgs, Instrumentation inst);</span><br><span class="line">（2） public static void premain(String agentArgs);</span><br></pre></td></tr></table></figure>

<p>   其中，如果两个方法同时存在，优先执行方法（1），忽略方法（2）</p>
<p>在premain方法内完成对类的各种操作，如替代或修改 。实际上就是修改或代替原有的类字节码。另外在premain方式下，JVM在执行main方法之前，先会调用代理程序的premain方法，其中inst参数是由JVM自动传入。</p>
</li>
</ol>
<ol start="2">
<li><p>配置代理应用的MANIFEST.MF文件</p>
<p>代理程序需要配置META-INF目录下MANIFEST.MF，配置内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Premain-Class: Premain</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Can-Retransform-Classes: true</span><br><span class="line">Boot-Class-Path：javassist.jar</span><br></pre></td></tr></table></figure>

<p>Premain-Class： 指定了代理使用的类，也就是，该类含有premain方法。当一个代理在JVM中启动时会从MANIFEST.MF找到对应的代理类。如果有命名空间，应该包含命名空间；</p>
<p>Can-Redefine-Classes:  指明代理JAR文件是否可以重新定义类。可选，默认为false。使用代理，需要设为true；</p>
<p>Boot-Class-Path:  指明该代理JAR文件中有用到的第三方jar包放到这里，例如代理要用到javassist.jar来操作操作字节码，就需要指定，并在打包的时候把Boot-Class-Path指定的jar包也一起打包；</p>
<p>Can-Retransform-Classes: 它的作用在于只有在代理JAR文件中<code>Can-Retransform-Classes</code>设置了 manifest属性 <code>true</code>并且JVM支持此功能时，才支持重新转换。在单个JVM的单个实例化期间，对此方法的多次调用将返回相同结果。默认为false。在agentmain方式下需要将该属性设为true。</p>
</li>
<li><p>代理程序 jar文件打包</p>
<p>需要把含premain代理程序、META-INF目录及文件、依赖包一同打包成jar。如打包成MyAgent.jar</p>
</li>
<li><p>运行</p>
<p><code>java  -javaagent: /path/to/martin6699s/MyAgent.jar  application.jar</code></p>
</li>
</ol>
<h4 id="（2）premain方式举例："><a href="#（2）premain方式举例：" class="headerlink" title="（2）premain方式举例："></a>（2）premain方式举例：</h4><p>随便建个项目命名为mainTest， 在mainTest项目中建一个类<code>TimeHelloWorld</code>，等会利用代理修改该类方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.myagent.martin6699s;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> martin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/9/9</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeHelloWorld</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            System.out.println(<span class="string">"hello world!!"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHelloMartin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            System.out.println(<span class="string">"hello martin!!"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再建一个含main方法的类<code>Main</code>作为程序入口，创建TimeHelloWorld并执行sayHello方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.myagent.martin6699s;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> martin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/9/11</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"开始------"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1</span>; i++) &#123;</span><br><span class="line">            TimeHelloWorld helloWorld = <span class="keyword">new</span> TimeHelloWorld();</span><br><span class="line">            helloWorld.sayHello();</span><br><span class="line">            helloWorld.sayHelloMartin();</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"结束------"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接运行Main类，输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">开始------</span><br><span class="line">hello world!!</span><br><span class="line">hello martin!!</span><br><span class="line">结束------</span><br></pre></td></tr></table></figure>

<p>现在需要计算sayHello和sayHelloMartin方法的执行时间，但又不想在这两方法内部加代码；</p>
<p>那执行main方法前把TimeHelloWorld类字节码替换成我们想要的字节码，</p>
<p>那接下来再建一个名为MyAgent的项目, 在MyAgent项目中建一个PremainTransformer类实现ClassFileTransformer接口，其中实现transform方法来完成字节码的替换。这里用到javassist进行字节码操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.myagent.martin6699s;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"><span class="keyword">import</span> javassist.CtNewMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.IllegalClassFormatException;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> martin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/9/9</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PremainTransformer</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> String prefix = <span class="string">"\nlong startTime = System.currentTimeMillis();\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> String postfix = <span class="string">"\nlong endTime = System.currentTimeMillis();\n"</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> List&lt;String&gt; methodList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PremainTransformer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       methodList.add(<span class="string">"com.myagent.martin6699s.TimeHelloWorld.sayHello"</span>);</span><br><span class="line">       methodList.add(<span class="string">"com.myagent.martin6699s.TimeHelloWorld.sayHelloMartin"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(className.startsWith(<span class="string">"com/myagent/martin6699s"</span>)) &#123;</span><br><span class="line">            <span class="comment">// 判断加载的类包名是不是我们需要目标类的包名</span></span><br><span class="line">            className = className.replaceAll(<span class="string">"/"</span>, <span class="string">"."</span>);</span><br><span class="line"></span><br><span class="line">            CtClass ctClass = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                ctClass = ClassPool.getDefault().get(className);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(String method: methodList) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(method.startsWith(className)) &#123;</span><br><span class="line"></span><br><span class="line">                        String methodName = method.</span><br><span class="line">                                substring(method.lastIndexOf(<span class="string">"."</span>) + <span class="number">1</span>, method.length());</span><br><span class="line"></span><br><span class="line">                        String outputStr = <span class="string">"\nSystem.out.println(\"方法执行时间:  "</span></span><br><span class="line">                                + methodName</span><br><span class="line">                                + <span class="string">"\" + (endTime - startTime) + \"ms.\");"</span>;</span><br><span class="line"></span><br><span class="line">                        CtMethod ctMethod = ctClass</span><br><span class="line">                                .getDeclaredMethod(methodName);</span><br><span class="line"></span><br><span class="line">                        String newMethodName = methodName + <span class="string">"$impl"</span>;</span><br><span class="line"></span><br><span class="line">                        ctMethod.setName(newMethodName);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//创建新的方法，复制原来的方法 ，名字为原来的名字</span></span><br><span class="line">                        CtMethod newMethod = CtNewMethod.copy(ctMethod, methodName, ctClass,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 构建新的方法体</span></span><br><span class="line">                        StringBuilder bodyStr = <span class="keyword">new</span> StringBuilder(<span class="number">250</span>);</span><br><span class="line">                        bodyStr.append(<span class="string">"&#123;"</span>);</span><br><span class="line">                        bodyStr.append(prefix);</span><br><span class="line">                        bodyStr.append(newMethodName+<span class="string">"($$);\n"</span>);</span><br><span class="line">                        bodyStr.append(postfix);</span><br><span class="line">                        bodyStr.append(outputStr);</span><br><span class="line">                        bodyStr.append(<span class="string">"&#125;"</span>);</span><br><span class="line"></span><br><span class="line">                        newMethod.setBody(bodyStr.toString());</span><br><span class="line">                        ctClass.addMethod(newMethod);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"准备替换-----"</span> + className);</span><br><span class="line">                <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"异常信息："</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后，需要在代理程序MyAgent中在建一个类，类中有premain方法: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package com.myagent.martin6699s;</span><br><span class="line"></span><br><span class="line">import java.lang.instrument.Instrumentation;</span><br><span class="line">import java.lang.instrument.UnmodifiableClassException;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author martin</span><br><span class="line"> * @date 2019/9/11</span><br><span class="line"> **/</span><br><span class="line">public class MyPremainAgent &#123;</span><br><span class="line"></span><br><span class="line">    public static void premain(String agentArgs, Instrumentation inst)</span><br><span class="line">            throws ClassNotFoundException, UnmodifiableClassException &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;进入---premain---start&quot;);</span><br><span class="line">        // 加转换类,可以加多个</span><br><span class="line">        inst.addTransformer(new PremainTransformer());</span><br><span class="line">        System.out.println(&quot;进入---premain---end&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在MyAgent项目中建META-INF/MANIFEST.MF文件，MANIFEST.MF文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Premain-Class: com.myagent.martin6699s.MyPremainAgent</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Boot-Class-Path: javassist.jar</span><br></pre></td></tr></table></figure>

<p>然后把MyAgent项目连同javassist.jar、MANIFEST.MF一起打包成MyAgent.jar，到放到<code>E:\MyAgent\target\</code>目录下</p>
<p>把mainTest项目两个类编译成.class文件输出<code>E:\Work\MultiProject\JAVASE6Agent\mainTest\target\production\mainTest</code>目录下</p>
<p>最后就可以执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:E:\MyAgent\target\MyAgent.jar -Dfile.encoding=UTF-8  -classpath &quot;E:\Work\MultiProject\JAVASE6Agent\mainTest\target\production\mainTest&quot; com.myagent.martin6699s.Main</span><br></pre></td></tr></table></figure>



<p>输出如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">进入---premain---start</span><br><span class="line">进入---premain---end</span><br><span class="line">准备替换-----com.myagent.martin6699s.Main</span><br><span class="line">开始------</span><br><span class="line">准备替换-----com.myagent.martin6699s.TimeHelloWorld</span><br><span class="line">hello world!!</span><br><span class="line">方法执行时间:  sayHello2000ms.</span><br><span class="line">hello martin!!</span><br><span class="line">方法执行时间:  sayHelloMartin1000ms.</span><br><span class="line">结束------</span><br></pre></td></tr></table></figure>



<h3 id="Agentmain方式"><a href="#Agentmain方式" class="headerlink" title="Agentmain方式"></a>Agentmain方式</h3><h4 id="（1）说明-1"><a href="#（1）说明-1" class="headerlink" title="（1）说明"></a>（1）说明</h4><p>agentmain方式是JAVA SE 6对Instrumentation的增强，支持程序启动后动态代理对类的转换，使用retransformClasses方法声明待转换的类，转换过程不会导致其初始化，静态变量的值保持不变，但它也有局限性，下面段话引自<code>JAVA SE 7 文档中关于Instrumentation restransformClasses方法介绍</code>:</p>
<blockquote>
<p>The retransformation may change method bodies, the constant pool and attributes. The retransformation must not add, remove or rename fields or methods, change the signatures of methods, or change inheritance. These restrictions maybe be lifted in future versions. The class file bytes are not checked, verified and installed until after the transformations have been applied, if the resultant bytes are in error this method will throw an exception.</p>
<p>If this method throws an exception, no classes have been retransformed.</p>
</blockquote>
<p>翻译过来就是：转换可以改变方法主体、常量池和属性。转换不能新增、删除、重命名字段和方法，不能改变方法签名，不能改变继承关系。在将来的版本可能会取消限制。在转换之前，不会对类文件字节码进行检查、检验、安装，如果转换后合成的字节码发生错误，restransformClasses方法将抛异常。 如果restransformClasses方法抛异常，将不会进行类转换，也就是不会改变类字节码。</p>
<p>因为这个局限性，导致之前运行代码是出现异常：</p>
<p><code>Caused by: java.lang.UnsupportedOperationException: class redefinition failed: attempted to add a method</code> </p>
<p>原因是：我在AgentmainTransformer类里面使用了和premain方式一样的代码，在类中构建了一个新的方法，导致异常，后来改成替换方法主体就通过了。</p>
<p>具体步骤：</p>
<ol>
<li>编写含agentmain方法的类及实现ClassFileTransformer的类；</li>
<li>编写META-INF/MANIFEST.MF文件；</li>
<li>打包jar；</li>
<li>编写控制程序模拟监控，实际上就是为了初始化并触发Attach Listener监听事件进程，动态代理替换原先字节码；</li>
<li>运行监控程序；</li>
</ol>
<h4 id="（2）Agentman方式举例"><a href="#（2）Agentman方式举例" class="headerlink" title="（2）Agentman方式举例"></a>（2）Agentman方式举例</h4><p>和premain一样同样需要mainTest项目来作为目标项目，但稍微改一下Main类，把for循环 <code>i &lt; 1</code>改为<code>i &lt; 60</code> 方便测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.myagent.martin6699s;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> martin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/9/11</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"开始------"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">60</span>; i++) &#123;</span><br><span class="line">            TimeHelloWorld helloWorld = <span class="keyword">new</span> TimeHelloWorld();</span><br><span class="line">            helloWorld.sayHello();</span><br><span class="line">            helloWorld.sayHelloMartin();</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"结束------"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>接下来编写AgentmainTransformer类，和PremainTransformer类不同的是直接修改方法体，而不是创建方法体副本（相当于创建新方法）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.myagent.martin6699s;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.IllegalClassFormatException;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> martin</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/9/9</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentmainTransformer</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> List&lt;String&gt; methodList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AgentmainTransformer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        methodList.add(<span class="string">"com.myagent.martin6699s.TimeHelloWorld.sayHello"</span>);</span><br><span class="line">        methodList.add(<span class="string">"com.myagent.martin6699s.TimeHelloWorld.sayHelloMartin"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(className.startsWith(<span class="string">"com/myagent/martin6699s"</span>)) &#123;</span><br><span class="line">            <span class="comment">// 判断加载的类包名是不是我们需要目标类的包名</span></span><br><span class="line">            className = className.replaceAll(<span class="string">"/"</span>, <span class="string">"."</span>);</span><br><span class="line"></span><br><span class="line">            CtClass ctClass = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                ctClass = ClassPool.getDefault().get(className);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(String method: methodList) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(method.startsWith(className)) &#123;</span><br><span class="line"></span><br><span class="line">                        String methodName = method.</span><br><span class="line">                                substring(method.lastIndexOf(<span class="string">"."</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                        CtMethod ctMethod = ctClass</span><br><span class="line">                                .getDeclaredMethod(methodName);</span><br><span class="line">                        ctMethod.addLocalVariable(<span class="string">"startTime"</span>, CtClass.longType);</span><br><span class="line">                        ctMethod.insertBefore(<span class="string">"startTime = System.currentTimeMillis();"</span>);</span><br><span class="line">                        ctMethod.insertAfter(<span class="string">"&#123;final long endTime = System.currentTimeMillis();\n System.out.println(\"方法("</span>+ className +<span class="string">"#"</span> + methodName +<span class="string">")执行时间: \" + (endTime-startTime) + \" 毫秒(ms) \");&#125;"</span>);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"准备替换-----"</span> + className);</span><br><span class="line">                <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                System.out.println(<span class="string">"异常信息："</span> + e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>含有agentmain方法的类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">package com.myagent.martin6699s;</span><br><span class="line"></span><br><span class="line">import java.lang.instrument.Instrumentation;</span><br><span class="line">import java.lang.instrument.UnmodifiableClassException;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author martin</span><br><span class="line"> * @date 2019/9/9</span><br><span class="line"> **/</span><br><span class="line">public class MyAgentmainAgent &#123;</span><br><span class="line"></span><br><span class="line">   public static void agentmain(String agentArgs, Instrumentation inst)</span><br><span class="line">       throws ClassNotFoundException, UnmodifiableClassException &#123;</span><br><span class="line"></span><br><span class="line">       String targetClassPath = &quot;com.myagent.martin6699s.TimeHelloWorld&quot;;</span><br><span class="line"></span><br><span class="line">       for(Class&lt;?&gt; clazz : inst.getAllLoadedClasses()) &#123;</span><br><span class="line"></span><br><span class="line">           if(!inst.isModifiableClass(clazz)) &#123;</span><br><span class="line">               continue;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if(clazz.getName().equals(targetClassPath)) &#123;</span><br><span class="line">               inst.addTransformer(new AgentmainTransformer(), true);</span><br><span class="line">               inst.retransformClasses(clazz);</span><br><span class="line">               System.out.println(&quot;Agent Main Done&quot;);</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后编写MANIFEST.MF配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Agent-Class: com.myagent.martin6699s.MyAgentmainAgent</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Can-Retransform-Classes: true</span><br><span class="line">Boot-Class-Path: javassist.jar</span><br></pre></td></tr></table></figure>

<p>其中Agent-Class指明代理jar中代理执行代码在那个类上</p>
<p>然后打包成MyAgent2.jar</p>
<p>为了运行 Attach API，我们需要一个控制程序来模拟监控过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.tools.attach.AgentInitializationException;</span><br><span class="line">import com.sun.tools.attach.AgentLoadException;</span><br><span class="line">import com.sun.tools.attach.AttachNotSupportedException;</span><br><span class="line">import com.sun.tools.attach.VirtualMachine;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author martin</span><br><span class="line"> * @date 2019/9/11</span><br><span class="line"> **/</span><br><span class="line">public class AttachTreadMain &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        String pid = args[0];</span><br><span class="line">        VirtualMachine vm = null;</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;pid=&quot; + pid);</span><br><span class="line">        try &#123;</span><br><span class="line">             vm = VirtualMachine.attach(pid);</span><br><span class="line">             vm.loadAgent(&quot;E:\\Work\\MultiProject\\JAVASE6Agent\\MyAgent2\\target\\MyAgent2.jar&quot;);</span><br><span class="line">        &#125; catch (AttachNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (AgentLoadException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; catch (AgentInitializationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if(vm != null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    vm.detach();</span><br><span class="line">                &#125; catch (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中loadAgent方法参数为MyAgent2.jar的文件绝对路径。</p>
<p>最后第二步，运行目标项目mainTest的Main类，通过<code>jps -l</code>找到Main类程序对应的pid是多少，假如pid=10012</p>
<p>最后把pid作为程序参数传给监控程序AttachTreadMain并运行。结果目标项目mainTest输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">开始------</span><br><span class="line">hello world!!</span><br><span class="line">hello martin!!</span><br><span class="line">hello world!!</span><br><span class="line">hello martin!!</span><br><span class="line">hello world!!</span><br><span class="line">hello martin!!</span><br><span class="line">hello world!!</span><br><span class="line">hello martin!!</span><br><span class="line">准备替换-----com.myagent.martin6699s.TimeHelloWorld</span><br><span class="line">Agent Main Done</span><br><span class="line">hello world!!</span><br><span class="line">方法(com.myagent.martin6699s.TimeHelloWorld#sayHello)执行时间: 2001 毫秒(ms) </span><br><span class="line">hello martin!!</span><br><span class="line">方法(com.myagent.martin6699s.TimeHelloWorld#sayHelloMartin)执行时间: 1000 毫秒(ms) </span><br><span class="line">......</span><br></pre></td></tr></table></figure>



<h5 id="坑点"><a href="#坑点" class="headerlink" title="坑点"></a>坑点</h5><p>agentmain方式需要指定Can-Retransform-Classes为true，否则会报异常<code>Caused by: java.lang.UnsupportedOperationException: adding retransformable transformers is not supported in this environment</code></p>
<p>到此是不是觉得这个功能很强大，以后就可以线上调试不用重启服务了，是不是很开森！</p>
<p>其实Intellij idea 调试、强大的Btrace bug跟踪调试工具、阿里出品的jvm-sandbox都是利用JAVA这种特性来做的。</p>
<p>示例代码放在github上了： <a href="https://github.com/martin6699s/java-examples/tree/master/Instrumentation" target="_blank" rel="noopener">https://github.com/martin6699s/java-examples/tree/master/Instrumentation</a></p>
<p>【参考链接】</p>
<p> <a href="https://www.ibm.com/developerworks/cn/java/j-lo-jse61/index.html" target="_blank" rel="noopener">IBM Java SE 6 特性 Instrumentation功能</a> </p>
<p><a href="https://docs.oracle.com/javase/7/docs/api/java/lang/instrument/Instrumentation.html" target="_blank" rel="noopener">Java SE 7 Instrumentation文档</a></p>
<p><a href="https://docs.oracle.com/javase/7/docs/jdk/api/attach/spec/com/sun/tools/attach/VirtualMachine.html" target="_blank" rel="noopener">Java SE 7 VirtualMachine文档</a></p>
<p><a href="https://blog.51cto.com/5162886/2044541" target="_blank" rel="noopener">java agent机制</a></p>
<p><a href="http://calvin1978.blogcn.com/articles/vjtools-tools4.html" target="_blank" rel="noopener">入门科普，围绕JVM的各种外挂技术</a></p>
<p><a href="https://blog.csdn.net/jinxin70/article/details/85690904" target="_blank" rel="noopener">JavaAgent源码分析</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">martin6699s(JinSheng Lin)</p>
              <p class="site-description motion-element" itemprop="description">IT or life article</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">martin6699s(JinSheng Lin)</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
